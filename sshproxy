#!/usr/bin/env node

var program = require('commander');
var cp = require('child_process');
var fs = require("fs");
var readline = require('readline');

var version = require(__dirname + '/package.json').version
var servers = require(__dirname + '/servers.json');
var proxyPort = 7070;

program.version(version);
program.command('start')
	.description('å¯åŠ¨SSHä»£ç†æœåŠ¡å™¨')
	.option('-i, --id <server-id>', 'æœåŠ¡å™¨ID')
	.action(start);
program.command('stop')
	.description('åœæ­¢SSHä»£ç†æœåŠ¡å™¨')
	.action(stop);
program.command('restart')
	.description('é‡å¯SSHä»£ç†æœåŠ¡å™¨')
	.action(restart);
program.command('state')
	.description('SSHä»£ç†æœåŠ¡å™¨çŠ¶æ€')
	.action(state);
program.command('set')
	.description('è®¾ç½®é»˜è®¤SSHä»£ç†æœåŠ¡å™¨')
	.option('-i, --id <server-id>', 'æœåŠ¡å™¨ID')
	.option('-P, --port <ssh-port>', 'ä»£ç†ç«¯å£', proxyPort)
	.action(set);
program.command('list')
	.description('SSHä»£ç†åˆ—è¡¨')
	.action(list);
program.command('add')
	.description('æ·»åŠ SSHä»£ç†æœåŠ¡å™¨')
	.option('-i, --id <server-id>', 'æœåŠ¡å™¨ID')
	.option('-h, --host <ssh-host>', 'æœåŠ¡å™¨åœ°å€')
	.option('-P, --port <ssh-port>', 'æœåŠ¡å™¨ç«¯å£', 22)
	.option('-u, --user <ssh-user>', 'æœåŠ¡å™¨ç”¨æˆ·å', 'root')
	.option('-p, --password <ssh-password>', 'æœåŠ¡å™¨å¯†ç ')
	.action(add);
program.command('del')
	.description('åˆ é™¤SSHä»£ç†æœåŠ¡å™¨')
	.option('-i, --id <server-id>', 'æœåŠ¡å™¨ID')
	.action(del);
program.command('clear')
	.description('æ¸…ç†SSHä»£ç†æœåŠ¡å™¨')
	.action(clear);
program.command('*').action(paramsError);
program.parse(process.argv);
if (process.argv.length === 2) paramsError();

function paramsError() {
	console.error('å‚æ•°é”™è¯¯ï¼\n\
sshproxy list/start/stop/restart/state/set/add/del/clear [options]\n\n\
å®ä¾‹ï¼š\n\
sshproxy list	 æŸ¥çœ‹æ‰€æœ‰SSHä»£ç†æœåŠ¡å™¨ä¿¡æ¯\n\
sshproxy start	 å¯åŠ¨é»˜è®¤çš„SSHä»£ç†æœåŠ¡å™¨\n\
sshproxy stop	 åœæ­¢SSHä»£ç†æœåŠ¡å™¨\n\
sshproxy restart é‡å¯SSHä»£ç†æœåŠ¡å™¨\n\
sshproxy state	 æŸ¥çœ‹SSHä»£ç†æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨\n\n\
sshproxy add -i ssh1 -h host -P port -u user -p password\næ·»åŠ SSHä»£ç†æœåŠ¡å™¨ï¼Œ-Pé»˜è®¤22ã€-ué»˜è®¤root\n\n\
sshproxy del -i ssh1		 åˆ é™¤SSHä»£ç†æœåŠ¡å™¨ssh1\n\
sshproxy set -i ssh1 -P port	 é…ç½®é»˜è®¤ä½¿ç”¨æœåŠ¡å™¨å’Œç»‘å®šç«¯å£ï¼Œé»˜è®¤7070\n\
sshproxy clear			 æ¸…ç†ä½¿ç”¨SSHä»£ç†æœåŠ¡å™¨\n\
');
		return false;
}
function start(opts) {
	if (!servers._currid_ || !servers._currid_.id || !servers._currid_.port) return error('è¯·é…ç½®é»˜è®¤æœåŠ¡å™¨ï¼');
	if (!servers[servers._currid_.id]) return error('æœåŠ¡å™¨IDä¸å­˜åœ¨ï¼');
	var server = servers[servers._currid_.id];
	var sshCMD = __dirname + '/ssh ' + server.user + '@' + server.host + ' ' + server.password + ' ' + server.port + ' ' + servers._currid_.port;
	return find(servers._currid_.port).then(function(pid) {
		if (pid) { info('ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨ï¼'); return 1; }
		return exec(sshCMD).then(function(err) {
			return find(servers._currid_.port).then(function(pid) {
				if (!pid) error('ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨ï¼'); else info('ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨ï¼');
				return 1;
			});
		});
	});
}
function find(port) {
	var findCMD = 'ps aux | grep "ssh -qTfnN -D ' + port + '"';
	return exec(findCMD).then(function(err){
		var errs = err.split('\n');
		for (var i = 0,len = errs.length; i < len; i++) {
			var e = errs[i];
			if (!e || e.indexOf('grep ') != -1) continue;
			var pid = e.match(/ (\d+) /g)[0].trim();
			return pid;
		}
		return null;
	});
}
function stop(opts) {
	if (!servers._currid_ || !servers._currid_.id || !servers._currid_.port) return error('è¯·é…ç½®é»˜è®¤æœåŠ¡å™¨ï¼');
	if (!servers[servers._currid_.id]) return error('æœåŠ¡å™¨IDä¸å­˜åœ¨ï¼');
	return find(servers._currid_.port).then(function(pid) {
		if (!pid) { error('ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨ï¼'); return null; }
		return exec('kill -9 ' + pid).then(function(r) {
			info('ä»£ç†æœåŠ¡å™¨å·²åœæ­¢ï¼');
			return 1;
		});
	});
}

function state(opts) {
	if (!servers._currid_ || !servers._currid_.id || !servers._currid_.port) return error('è¯·é…ç½®é»˜è®¤æœåŠ¡å™¨ï¼');
	if (!servers[servers._currid_.id]) return error('æœåŠ¡å™¨IDä¸å­˜åœ¨ï¼');
	return find(servers._currid_.port).then(function(pid) {
		if (!pid) error('ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨ï¼'); else info('ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨ï¼');
		return 1;
	});
}
function restart(opts) {
	return stop().then(start);
}
function set(opts) {
	if (!opts.id) return error('è¯·è¾“å…¥æœåŠ¡å™¨IDï¼');
	if (!servers[opts.id]) return error('æœåŠ¡å™¨IDä¸å­˜åœ¨ï¼');
	servers._currid_ = { id: opts.id, port: opts.port };
	writeServers(function() {
		info('è®¾ç½®é»˜è®¤æœåŠ¡å™¨æˆåŠŸï¼š\n' + opts.id + ' ' + JSON.stringify(servers[opts.id]));
	});
}
function list(opts) {
	var msg = 'æœåŠ¡å™¨åˆ—è¡¨ï¼š';
	for (var id in servers) msg += '\n' + id + ' ' + JSON.stringify(servers[id]);
	if (msg.length == 6) msg += '\næ— ';
	info(msg);
}
function add(opts) {
	if (!opts.id) return error('è¯·è¾“å…¥æœåŠ¡å™¨IDï¼');
	if (!opts.host) return error('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼');
	if (!opts.password) return error('è¯·è¾“å…¥å¯†ç ï¼');
	if (servers[opts.id]) return error('æœåŠ¡å™¨IDå·²ç»å­˜åœ¨ï¼');
	if (!servers._currid_) servers._currid_ = { id: opts.id, port: proxyPort };
	servers[opts.id] = { host: opts.host, port: opts.port, user: opts.user, password: opts.password };
	writeServers(function() {
		info('æ·»åŠ æœåŠ¡å™¨æˆåŠŸï¼š\n' + opts.id + ' ' + JSON.stringify(servers[opts.id]));
	});
}
function del(opts) {
	if (!opts.id) return error('è¯·è¾“å…¥æœåŠ¡å™¨IDï¼');
	if (!servers[opts.id]) return error('æœåŠ¡å™¨IDä¸å­˜åœ¨ï¼');
	var server = servers[opts.id];
	var rl = readline.createInterface(process.stdin, process.stdout);
	rl.setPrompt('ç¡®å®šåˆ é™¤æœåŠ¡å™¨é…ç½®å—ï¼Ÿy/n > ');
	rl.prompt();
	rl.on('line', function(line) {
		line = line.trim().toLowerCase()
		if (line === 'y') {
			delete servers[opts.id];
			if (servers['_currid_'] == opts.id) delete servers['_currid_'];
			writeServers(function() {
				info('åˆ é™¤æœåŠ¡å™¨æˆåŠŸï¼š\n' + opts.id + ' ' + JSON.stringify(server));
				process.exit(0);
			});
		} else process.exit(0);
	});
}
function clear(opts) {
	var rl = readline.createInterface(process.stdin, process.stdout);
	rl.setPrompt('ç¡®å®šæ¸…ç†æ‰€æœ‰æœåŠ¡å™¨é…ç½®å—ï¼Ÿy/n > ');
	rl.prompt();
	rl.on('line', function(line) {
		line = line.trim().toLowerCase()
		if (line === 'y') {
			servers = {};
			writeServers(function() {
				info('æ¸…ç†æ‰€æœ‰æœåŠ¡å™¨æˆåŠŸ');
				process.exit(0);
			});
		} else process.exit(0);
	});
}

function exec(cmd, option) {
	return new Promise(function(resolve, reject) {
		cp.exec(cmd, option, function(err, stdout, stderr) {
			if (err) error(cmd + ' æ‰§è¡Œé”™è¯¯ï¼š\n' + err.message);
			if (stderr) error(cmd + ' æ‰§è¡Œå¤±è´¥ï¼š\n' + stderr);
			resolve(err ? '' : stdout);
		});
	});
}
function now() {
	var date = new Date();
	var year = date.getFullYear();
	var month = date.getMonth()+1;
	var day = date.getDate();
	var hour = date.getHours();
	var minute = date.getMinutes();
	var second = date.getSeconds();
	var ss = year + '-';
	ss += (month < 10 ? ('0' + month) : month) + '-';
	ss += (day < 10 ? ('0' + day) : day) + ' ';
	ss += (hour < 10 ? ('0' + hour) : hour) + ':';
	ss += (minute < 10 ? ('0' + minute) : minute) + ':';
	ss += second < 10 ? ('0' + second) : second;
	return ss;
}
function write(msg) {
	msg = msg.replace(/\[\d+m/g, '').replace(//g, '') + '\n';
	fs.appendFileSync(__dirname + '/sshproxy.log', msg, 'utf8');
}
function info(msg) {
	msg = now() + ' [INFO] ' + msg;
	console.log(msg);
	write(msg);
}
function error(msg) {
	msg = now() + ' [ERROR] ' + msg;
	console.error(msg);
	write(msg);
}
function writeServers(cb) {
	fs.writeFile(__dirname + '/servers.json', JSON.stringify(servers), 'utf8', cb);
}
